
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Web & iOS dev – Ruby, Rails, RubyMotion & React</title>
  <meta name="author" content="Paul Sturgess">

  
  <meta name="description" content="This is the beginning of a series of blog posts I intend to write on how I&#8217;ve built Title Challenge – Football Management. It&#8217;s an iOS &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://paulsturgess.github.io/blog/page/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Web & iOS dev – Ruby, Rails, RubyMotion & React" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-75197-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Web & iOS dev – Ruby, Rails, RubyMotion & React</a></h1>
  
    <h2>Paul Sturgess</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Index</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://twitter.com/paulsturgess">@paulsturgess</a></li>
  <li><a href="https://github.com/paulsturgess">Github</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/13/using-reveal-app-to-build-a-rubymotion-football-manager-game/">Using Reveal App to Build a RubyMotion Football Manager Game</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-13T15:26:00+00:00" pubdate data-updated="true">Feb 13<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is the beginning of a series of blog posts I intend to write on how I&#8217;ve built <a href="http://titlechallenge.com">Title Challenge – Football Management</a>.</p>

<p>It&#8217;s an iOS game I&#8217;ve written in <a href="http://www.rubymotion.com/">RubyMotion</a>. I&#8217;m a Ruby on Rails web developer turned app developer. Before building this game, I had no prior knowledge of building mobile applications.</p>

<p>Hopefully this series of posts will inspire other Ruby developers out there to start building really cool mobile apps.</p>

<p><a href="http://revealapp.com/">Reveal App</a> was one of the first third-party tools I downloaded when I started building Title Challenge 18 months ago and I&#8217;ve used it nearly every day since. At first glance it might look like a bit of a gimmick to see your app in 3D but it is incredibly useful for debugging.</p>

<p><a href="/images/reveal_app.png" target="_blank"><img class="left" src="/images/reveal_app.png" width="825" height="825" title="Reveal App screenshot" alt="Reveal App screenshot"></a></p>

<p>I&#8217;ve used Reveal to show me when a <code>UIView</code> is tucked behind some other <code>UIView</code> that I couldn&#8217;t see in the Simulator. Sometimes a <code>UIVIew</code> might not have a height set or something stupid like that and Reveal would instantly show me.</p>

<p>You can rotate your app round to see it from angles you can&#8217;t see in the Simulator.</p>

<p>Another really useful feature is being able to tweak attributes live in the Reveal and the Simulator reflects your changes. For example, you can change the frame of a <code>UIView</code> and see it move in the simulator live.</p>

<p>I&#8217;ve got no affiliation with Reveal but I definitely recommend it for App developers.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/05/tweeting-a-screenshot-in-rubymotion-with-uiactivityviewcontroller/">Tweeting a Screenshot in RubyMotion With UIActivityViewController</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-05T18:47:00+00:00" pubdate data-updated="true">Feb 5<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The easiest way to allow users to share content from inside your app is to use <code>UIActivityViewController</code>.</p>

<p>Use it when you want to allow the user to:</p>

<ul>
<li>Send a Tweet</li>
<li>Share on Facebook</li>
<li>Save an image to photos</li>
<li>Send an SMS message / iMessage</li>
<li>Send an email</li>
</ul>


<p>In iOS 8 it slides up a panel at the bottom of the screen. The user chooses
how they want to share the content. The options are based on the applications
they have installed. You can also specify which ones to include/exclude.</p>

<p>Here&#8217;s enough code to create an app with a button that brings up the <code>UIActivityViewController</code>,
takes a screenshot and allows the user to share it along with some text.</p>

<p>Hopefully the code and my comments are self-documenting enough to make sense.</p>

<p>I figured this out through a combination of the Apple docs and this <a href="http://nshipster.com/uiactivityviewcontroller/">NSHipster article</a>.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">AppDelegate</span>

  <span class="kp">attr_reader</span> <span class="ss">:window</span>

  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>
    <span class="n">rootViewController</span> <span class="o">=</span> <span class="no">MyController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="n">rootViewController</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;ActivityViewController Demo&#39;</span>
    <span class="n">rootViewController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>

    <span class="n">navigationController</span> <span class="o">=</span> <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span>
      <span class="n">rootViewController</span>
    <span class="p">)</span>

    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">navigationController</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>

    <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># This subclass is not technically required</span>
<span class="c1"># It allows you to switch the text based on the type of service it will be shared on</span>
<span class="k">class</span> <span class="nc">ShareText</span> <span class="o">&lt;</span> <span class="no">UIActivityItemProvider</span>

  <span class="kp">attr_accessor</span> <span class="ss">:text</span>

  <span class="c1"># The placeholder text</span>
  <span class="k">def</span> <span class="nf">activityViewControllerPlaceholderItem</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
    <span class="s2">&quot;&quot;</span>
  <span class="k">end</span>

  <span class="c1"># The text that will be inserted into the Tweet / Email / SMS etc.</span>
  <span class="c1"># You could easily respond to more activity types if you wanted</span>
  <span class="k">def</span> <span class="nf">activityViewController</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="ss">itemForActivityType</span><span class="p">:</span> <span class="n">activityType</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">activityType</span> <span class="o">==</span> <span class="no">UIActivityTypePostToTwitter</span>
      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">text</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">twitter_handle</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">hashtag</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">text</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">website</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">hashtag</span>
    <span class="s2">&quot;#yourhashtag&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">website</span>
    <span class="s2">&quot;http://yourwebsite.com&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">twitter_handle</span>
    <span class="s2">&quot;@YourTwitterHandle&quot;</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="c1"># This is a simple controller with one button</span>
<span class="k">class</span> <span class="nc">MyController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">viewDidLoad</span>
    <span class="n">button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
    <span class="n">button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
    <span class="n">button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span>
      <span class="nb">self</span><span class="p">,</span>
      <span class="ss">action</span><span class="p">:</span> <span class="s1">&#39;button_tapped&#39;</span><span class="p">,</span>
      <span class="ss">forControlEvents</span><span class="p">:</span> <span class="no">UIControlEventTouchUpInside</span>
    <span class="p">)</span>
    <span class="n">button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">260</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">40</span><span class="o">]]</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">button</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># This method generates the image of the entire screen</span>
  <span class="c1"># Note it will not include the status bar</span>
  <span class="k">def</span> <span class="nf">screenshot</span>
    <span class="n">window</span> <span class="o">=</span> <span class="no">UIApplication</span><span class="o">.</span><span class="n">sharedApplication</span><span class="o">.</span><span class="n">keyWindow</span>
    <span class="no">UIGraphicsBeginImageContextWithOptions</span><span class="p">(</span>
      <span class="n">window</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
      <span class="kp">false</span><span class="p">,</span>
      <span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">scale</span>
    <span class="p">)</span>
    <span class="n">window</span><span class="o">.</span><span class="n">drawViewHierarchyInRect</span><span class="p">(</span>
      <span class="n">window</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
      <span class="ss">afterScreenUpdates</span><span class="p">:</span><span class="kp">true</span>
    <span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="no">UIGraphicsGetImageFromCurrentImageContext</span><span class="p">()</span>
    <span class="no">UIGraphicsEndImageContext</span><span class="p">()</span>
    <span class="n">image</span>
  <span class="k">end</span>

  <span class="c1"># We create an instance of our ShareText subclass</span>
  <span class="c1"># Pass it into the UIActivityViewController along with the screenshot</span>
  <span class="c1"># The UIActivityViewController handles everything else, all you have to do is present the controller.</span>
  <span class="k">def</span> <span class="nf">button_tapped</span>
    <span class="n">tc_share_text</span> <span class="o">=</span> <span class="no">ShareText</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="n">tc_share_text</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Check out this screengrab!&quot;</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="no">UIActivityViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithActivityItems</span><span class="p">(</span>
      <span class="o">[</span><span class="n">tc_share_text</span><span class="p">,</span> <span class="n">screenshot</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">applicationActivities</span><span class="p">:</span> <span class="kp">nil</span>
    <span class="p">)</span>

    <span class="n">controller</span><span class="o">.</span><span class="n">excludedActivityTypes</span> <span class="o">=</span> <span class="o">[</span>
      <span class="no">UIActivityTypePrint</span><span class="p">,</span>
      <span class="no">UIActivityTypeAssignToContact</span><span class="p">,</span>
      <span class="no">UIActivityTypeAddToReadingList</span><span class="p">,</span>
      <span class="no">UIActivityTypePostToFlickr</span><span class="p">,</span>
      <span class="no">UIActivityTypeAirDrop</span>
    <span class="o">]</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">presentViewController</span><span class="p">(</span>
      <span class="n">controller</span><span class="p">,</span>
      <span class="ss">animated</span><span class="p">:</span><span class="kp">true</span><span class="p">,</span>
      <span class="ss">completion</span><span class="p">:</span><span class="kp">nil</span>
    <span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/07/using-nsuserdefaults-in-rubymotion/">Using NSUserDefaults in RubyMotion</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-07T09:19:00+01:00" pubdate data-updated="true">May 7<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Apple describe <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/nsuserdefaults_Class/Reference/Reference.html">NSUserDefaults</a> as &#8220;a programmatic interface for interacting with the defaults system&#8221;.</p>

<p>It also provides a convenient store for persisting and retrieving user preferences for your application. You can think of it as a <code>key</code> <code>value</code> hash like structure, although it is a bit smarter than that.</p>

<p>Here&#8217;s a really simple implementation I&#8217;ve been using:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Cache
</span><span class='line'>
</span><span class='line'>  class &lt;&lt; self
</span><span class='line'>
</span><span class='line'>    def set_default(key, data)
</span><span class='line'>      return if read(key)
</span><span class='line'>      write(key, data)
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    def write(key, data)
</span><span class='line'>      NSUserDefaults.standardUserDefaults[storage_key(key)] = data
</span><span class='line'>      NSUserDefaults.standardUserDefaults.synchronize
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    def read(key)
</span><span class='line'>      NSUserDefaults.standardUserDefaults[storage_key(key)]
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    private
</span><span class='line'>
</span><span class='line'>    def storage_key_prefix
</span><span class='line'>      "#{cache_namespace}_"
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    def storage_key key
</span><span class='line'>      "#{storage_key_prefix}#{key}"
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    def cache_namespace
</span><span class='line'>      raise NotImplementedError
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class UserSearchSettings &lt; Cache
</span><span class='line'>
</span><span class='line'>  class &lt;&lt; self
</span><span class='line'>
</span><span class='line'>    private
</span><span class='line'>
</span><span class='line'>    def cache_namespace
</span><span class='line'>      "user_search"
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<p>I use it like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>UserSearchSettings.write("sort_by", "name")
</span><span class='line'>=&gt; true
</span><span class='line'>NSUserDefaults.standardUserDefaults.dictionaryRepresentation
</span><span class='line'>=&gt; {"user_search_sort_by" =&gt; "name"} # note there will be a lot of other key values in the hash
</span><span class='line'>UserSearchSettings.read("sort_by")
</span><span class='line'>=&gt; "name"</span></code></pre></td></tr></table></div></figure>


<p>My intention is not to call the <code>Cache</code> class directly and to only use the subclass <code>UserSearchSettings</code>. This forces me to group settings with a prefix defined by the <code>cache_namespace</code> method. This will help avoid accidentally defining the same key name for different values. It also nicely groups related settings.</p>

<p>Each application has its&#8217; own <code>NSUserDefaults.standardUserDefaults</code> so there is no need to prefix the keys with the application name.</p>

<p>This store will persist until the user removes your application from their device.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/20/using-magicalrecord-and-core-data-in-rubymotion/">Using MagicalRecord and Core Data in RubyMotion</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-20T13:36:00+00:00" pubdate data-updated="true">Feb 20<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/magicalpanda/MagicalRecord">MagicalRecord</a> is a wrapper around Apple&#8217;s <a href="http://en.wikipedia.org/wiki/Core_Data">Core Data Framework</a>. Written in Objective-C,
it&#8217;s one of the most popular and mature libraries for working with Core Data.</p>

<p>I really like it as it simplifies a lot of the code, whilst
it still allows you to &#8216;get your hands dirty&#8217; when necessary.</p>

<p>This article details how I&#8217;m using it. This is by no means the &#8216;perfect&#8217; solution,
as I am evolving it all the time, but it is working well for me. By all means
get in touch if you think I&#8217;m missing any obvious tricks.</p>

<p>One thing I have found is that it&#8217;s pretty much impossible to hide the fact you
are using CoreData. Particularly with the requirement of a different context for each
thread. But what I do want to do is make things as simple, consistent and maintainable
as possible.</p>

<h2>Installation</h2>

<p>At the time of writing I&#8217;m using the <a href="https://github.com/magicalpanda/MagicalRecord/tree/release/3.0">MagicalRecord 3.0 branch</a>,
installed via <a href="https://github.com/HipByte/motion-cocoapods">motion-cocoaopds</a>. My <code>Rakefile</code> includes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app.pods do
</span><span class='line'>  pod 'MagicalRecord', :git =&gt; 'https://github.com/magicalpanda/MagicalRecord.git', :branch =&gt;'release/3.0'
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h2>Wrapping MagicalRecord</h2>

<p>First I have a <code>Database</code> class to wrap common MagicalRecord tasks.</p>

<p>The main reason for this class is so that I do not sprinkle MagicalRecord calls
all around my code. Having them all in one place will make it easy to update if/when
the MagicalRecord api changes. It also encourages consistency in my usage of MagicalRecord
as, for example, there are many ways to persist your data.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Database
</span><span class='line'>
</span><span class='line'>  def self.filename
</span><span class='line'>    "YourApplicationName.sqlite"
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.path
</span><span class='line'>    File.join(
</span><span class='line'>      NSSearchPathForDirectoriesInDomains(NSApplicationSupportDirectory, NSUserDomainMask, true),
</span><span class='line'>      "YourApplicationName",
</span><span class='line'>      self.filename
</span><span class='line'>    )
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.created?
</span><span class='line'>    File.exist?(self.path)
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.loadOrCreate
</span><span class='line'>    MagicalRecord.setupAutoMigratingStack
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.createTestDB
</span><span class='line'>    MagicalRecord.setupStackWithInMemoryStore
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.delete
</span><span class='line'>    if self.created?
</span><span class='line'>      self.cleanUp
</span><span class='line'>      File.delete(self.path)
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.reset
</span><span class='line'>    Database.delete
</span><span class='line'>    Database.loadOrCreate
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.cleanUp
</span><span class='line'>    MagicalRecord.cleanUp
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.defaultLocalContext
</span><span class='line'>    MagicalRecordStack.defaultStack.context
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.backgroundLocalContext
</span><span class='line'>    NSManagedObjectContext.MR_confinementContextWithParent(defaultLocalContext)
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.save_specific_context(localContext, callback = nil)
</span><span class='line'>    localContext.MR_saveToPersistentStoreWithCompletion(
</span><span class='line'>      lambda { |success, error|
</span><span class='line'>        NSLog("success: %@", success)
</span><span class='line'>        if success
</span><span class='line'>          callback.call if callback
</span><span class='line'>        else
</span><span class='line'>          NSLog "Error saving Seed Data"
</span><span class='line'>          NSLog("description: %@", error.description)
</span><span class='line'>        end
</span><span class='line'>      }
</span><span class='line'>    )
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.save_test_db!
</span><span class='line'>    defaultLocalContext.MR_saveToPersistentStoreAndWait
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.save_on_main_thread!(callback = nil)
</span><span class='line'>    defaultLocalContext.MR_saveToPersistentStoreWithCompletion(
</span><span class='line'>      lambda { |success, error|
</span><span class='line'>        NSLog("success: %@", success)
</span><span class='line'>        if success
</span><span class='line'>          callback.call(defaultLocalContext) if callback
</span><span class='line'>        else
</span><span class='line'>          NSLog "Error saving Core Data"
</span><span class='line'>          NSLog("description: %@", error.description)
</span><span class='line'>        end
</span><span class='line'>      }
</span><span class='line'>    )
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.save_on_background_thread!(callback = nil, completion_callback = nil)
</span><span class='line'>    MagicalRecord.saveWithBlock(
</span><span class='line'>      lambda { |localContext|
</span><span class='line'>        callback.call(localContext) if callback
</span><span class='line'>      },
</span><span class='line'>      completion: lambda { |success, error|
</span><span class='line'>        NSLog("success: %@", success)
</span><span class='line'>        if success
</span><span class='line'>          completion_callback.call if completion_callback
</span><span class='line'>        else
</span><span class='line'>          NSLog "Error saving Core Data"
</span><span class='line'>          NSLog("description: %@", error.description)
</span><span class='line'>        end
</span><span class='line'>      }
</span><span class='line'>    )
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>In <code>AppDelegate</code> <code>didFinishLaunchingWithOptions</code> I call <code>Database.loadOrCreate</code>. As the name implies, this
will either load my existing Core Data stack or it will set up a new one.</p>

<p>I also cleanup the database when my app closes via this method in the <code>AppDelegate</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  def applicationWillTerminate application
</span><span class='line'>    Database.cleanUp
</span><span class='line'>  end</span></code></pre></td></tr></table></div></figure>


<h2>Entities</h2>

<p><del>I create my Core Data entities in Xcode (although I do intend to look at the <a href="https://github.com/infinitered/ruby-xcdm">ruby-xcdm gem</a> so I can stop using Xcode).</del> I&#8217;m now using the <a href="https://github.com/infinitered/ruby-xcdm">ruby-xcdm</a> gem to define my schema in code. Here&#8217;s a <a href="http://paulsturgess.co.uk/blog/2015/05/12/core-data-in-rubymotion-defining-your-schema-in-code/">blog post about it</a>.</p>

<p>For now, the <a href="https://github.com/yury/ib">ib gem</a> is great for allowing us to fire up Xcode just when we need it.
The gem is mostly geared around using Interface Builder but I don&#8217;t use it for that.</p>

<p>Once you&#8217;ve installed the gem run:</p>

<pre><code>$ rake ib:open
</code></pre>

<p>This will open Xcode. Inside the Resources folder on the left hand side there
will be a <code>.xcdatamodeld</code> file. Select this and you can create your entities.</p>

<p>One thing to remember is to set the <code>Class</code> of each Entity to the corresponding <code>Class</code>
in your app. Otherwise it will be a standard <code>NSManagedObject</code>.</p>

<p>So for each Entiy I create a corresponding class like so. Note it inherits from my
own <code>CustomNSManagedObject</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class ToDoItem &lt; CustomNSManagedObject
</span><span class='line'>  # more methods go here
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>I give each Entity <code>created_at</code> and <code>id</code> attributes in order to help with querying.</p>

<h2>ActiveRecord Style Behaviour</h2>

<p>The subclass of NSManagedObject I use looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class CustomNSManagedObject &lt; NSManagedObject
</span><span class='line'>
</span><span class='line'>  def self.defaultContext
</span><span class='line'>    CurrentSaveGame.localContext
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.all(context = nil)
</span><span class='line'>    localContext = context || defaultContext
</span><span class='line'>    self.MR_findAllSortedBy("created_at", ascending:true, inContext: localContext)
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.first(context = nil)
</span><span class='line'>    localContext = context || defaultContext
</span><span class='line'>    self.MR_findFirstOrderedByAttribute("created_at", ascending:true, inContext: localContext)
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.last(context = nil)
</span><span class='line'>    localContext = context || defaultContext
</span><span class='line'>    self.MR_findFirstOrderedByAttribute("created_at", ascending:false, inContext: localContext)
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.count
</span><span class='line'>    self.MR_numberOfEntities
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.find(id, context = nil)
</span><span class='line'>    localContext = context || defaultContext
</span><span class='line'>    self.MR_findFirstByAttribute("id", withValue:id, inContext: localContext)
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.new(attributes)
</span><span class='line'>    self.build(attributes)
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def self.build(attributes = {}, context = nil)
</span><span class='line'>    localContext = context || defaultContext
</span><span class='line'>    model = self.MR_createInContext(localContext)
</span><span class='line'>    model.setValuesForKeysWithDictionary(attributes)
</span><span class='line'>    model.created_at = Time.now
</span><span class='line'>    model
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def switch_context(localContext)
</span><span class='line'>    self.MR_inContext(localContext)
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def attributes
</span><span class='line'>    self.entity.attributesByName.keys.each_with_object({}) do |attribute, attributes_hash|
</span><span class='line'>      attributes_hash[attribute] = self.send(attribute)
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Essentially this class gives me ActiveRecord like behaviour. Also, like my <code>Database</code> class,
it ensures I contain some more <code>MagicalRecord</code> calls to a single place.</p>

<p>This means I can do:</p>

<pre><code>ToDoItem.build(
  {
    id: 1,
    action: "Lorem ipsum dolor sit amet"
  }
)
</code></pre>

<p>My build method automatically inserts a <code>created_at</code> for every new record.</p>

<h2>Data store</h2>

<p>By default <code>MagicalRecord.setupAutoMigratingCoreDataStack</code> will use SQLite to
persist your data.</p>

<p>Note that I don&#8217;t include a <code>save</code> method in <code>CustomNSManagedObject</code>. Saving an individual
record isn&#8217;t the most efficient way to persist changes in Core Data. Everything is held
in memory until the relevant context is told to save. Hence why I&#8217;ve put the
<code>save</code> method in the <code>Database</code> class.</p>

<h2>Persisting data on the main thread</h2>

<p>If you&#8217;ve used any of the CustomNSManagedObject methods like <code>find</code>, <code>all</code>, or <code>build</code>
without passing in a context then using <code>Database.save_on_main_thread!</code> will persist any
changes made. For example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>new_item = ToDoItem.build(
</span><span class='line'>  {
</span><span class='line'>    id: 2
</span><span class='line'>    action: "Some other todo item"
</span><span class='line'>  }
</span><span class='line'>)
</span><span class='line'>Database.save_on_main_thread!</span></code></pre></td></tr></table></div></figure>


<h2>Persisting data on background threads</h2>

<p>However, if updates are made on a background thread, then we need a new (temporary)
context which is handled by <code>Database.save_on_background_thread!</code>.</p>

<p>For example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Database.save_on_background_thread!(
</span><span class='line'>  lambda { |localContext|
</span><span class='line'>    new_item = ToDoItem.build(
</span><span class='line'>      {
</span><span class='line'>        id: 2
</span><span class='line'>        action: "Some other todo item"
</span><span class='line'>      },
</span><span class='line'>      localContext
</span><span class='line'>    )
</span><span class='line'>  }
</span><span class='line'>)</span></code></pre></td></tr></table></div></figure>


<p>Alternatively if you don&#8217;t want to wrap everything in the block. Create a
<code>localContext</code> and hold on to it. Make your changes and then save later down the line.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>localContext = Database.backgroundLocalContext
</span><span class='line'>new_item = ToDoItem.build(
</span><span class='line'>  {
</span><span class='line'>    id: 2
</span><span class='line'>    action: "Some other todo item"
</span><span class='line'>  },
</span><span class='line'>  localContext
</span><span class='line'>)
</span><span class='line'>Database.save_specific_context(localContext)</span></code></pre></td></tr></table></div></figure>


<p>Note most of the class methods in <code>CustomNSManagedObject</code> take an optional context so they
can be used on background threads.</p>

<h2>Testing</h2>

<p>For tests I use the in memory data store and when saving it is synchronous. This ensures the data is there before the assertions!</p>

<p>For example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>describe "SomeTest" do
</span><span class='line'>
</span><span class='line'>  before do
</span><span class='line'>    Database.cleanUp
</span><span class='line'>    Database.createTestDB
</span><span class='line'>    @localContext = Database.defaultLocalContext
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  describe "some_method" do
</span><span class='line'>
</span><span class='line'>    context "when some scenario" do
</span><span class='line'>
</span><span class='line'>      it "should assign something is true" do
</span><span class='line'>        # ...
</span><span class='line'>      end
</span><span class='line'>
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/29/logging-to-the-console-in-rubymotion/">Logging to the Console in RubyMotion</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-29T08:44:00+00:00" pubdate data-updated="true">Oct 29<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The simplest way to output to the console from your RubyMotion app is to use
<code>puts</code>. This works fine when your app is running in the simulator. However,
<code>puts</code> does not output to the console when your app is running on the device
itself.</p>

<p>You can view the live logs while your app is running on your usb connected device via:</p>

<pre><code>$ motion device:console
</code></pre>

<p>You will see messages from your application alongside those from other apps or
the system itself.</p>

<p>Instead of using <code>puts</code>, you&#8217;ll need to make use of <code>NSLog</code>. For example</p>

<pre><code>NSLog("My debug messge")
</code></pre>

<p>Note, however, that the first argument for <code>NSLog</code> is actually a <a href="https://developer.apple.com/library/ios/documentation/cocoa/conceptual/Strings/Articles/formatSpecifiers.html">String Format Specifier</a>.</p>

<p>The following are equivalent:</p>

<pre><code>puts "A #{variable} goes here"
NSLog("A %@ goes here", variable)
</code></pre>

<p>Just remember that any <code>NSLog</code> messages you leave in your app will be visible
to the curious, even after you&#8217;ve released to the App Store.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/16/using-lldb-to-debug-a-rubymotion-app/">Using LLDB to Debug a RubyMotion App</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-16T12:37:00+01:00" pubdate data-updated="true">Oct 16<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>RubyMotion now uses <a href="http://lldb.llvm.org/">LLDB</a> for debugging. Previously it
used GDB.</p>

<p>If you&#8217;re getting random crashes with little or no backtrace it may be down to
a memory allocation issue.</p>

<p>Launch your application with the debugger running via:</p>

<pre><code>$ bundle exec rake debug=1 NSZombieEnabled=YES MallocStackLogging=1
</code></pre>

<p>Trigger your bug and you should get output in Terminal like this:</p>

<pre><code>2013-10-16 10:17:19.594 YourAppName[68253:a0b] *** -[UIBarButtonItem isSystemItem]: message sent to deallocated instance 0x9fd56f0
Process 68253 stopped
* thread #1: tid = 0x3127cd, 0x03ac0811 CoreFoundation`___forwarding___ + 769, queue = 'com.apple.main-thread, stop reason = EXC_BREAKPOINT (code=EXC_I386_BPT, subcode=0x0)
    frame #0: 0x03ac0811 CoreFoundation`___forwarding___ + 769
CoreFoundation`___forwarding___ + 769:
-&gt; 0x3ac0811:  jmp    0x3ac090c                 ; ___forwarding___ + 1020
   0x3ac0816:  movl   %edi, (%esp)
   0x3ac0819:  calll  0x3bb840e                 ; symbol stub for: class_getSuperclass
   0x3ac081e:  movl   %eax, %edi
(lldb)
</code></pre>

<p>Leave your application running and open a separate tab in Terminal. You can
inspect the <code>malloc_history</code> of the object that has been deallocated via:</p>

<pre><code>/usr/bin/malloc_history 68253 0x9fd56f0
</code></pre>

<p>Note the first argument is the Process ID as indicated where it says
<code>Process 68253 stopped</code>. Note that the Ruby process that performs the build and
launches your app (i.e. rake) is not the same as your app process.</p>

<p>The last argument is the Object Reference as indicated by <code>message sent to deallocated instance 0x9fd56f0</code>.</p>

<p>This (hex) number is the address of a piece of memory where the object we are
interested in (was) located. The other traces in the malloc history are cases
where that same memory location was used.</p>

<p>Running the above command will give you a dump of information from the stack logs.
I&#8217;ve truncated the following example, as the information is plentiful, but it
shows the kind of output you can expect:</p>

<pre><code>malloc_history Report Version:  2.0
Process:         YourAppName [68253]
Path:            /path/to/YourAppName
Load Address:    0x1000
Identifier:      YourAppName
Version:         ??? (???)
Code Type:       X86 (Native)
Parent Process:  debugserver [68922]

Date/Time:       2013-10-16 11:14:24.104 +0100
OS Version:      Mac OS X 10.8.5 (12F45)
Report Version:  7

ALLOC 0x9fd56f0-0xa64da98 [size=425]: thread_4925a28 |start | main | UIApplicationMain | -[UIApplication _run] | CFRunLoopRunInMode | CFRunLoopRunSpecific | __CFRunLoopRun | __CFRunLoopDoSource1 | __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__ | PurpleEventCallback | _PurpleEventCallback | _UIApplicationHandleEvent | -[UIApplication sendEvent:] | ...

FREE  0x9fd56f0-0xa64da98 [size=425]: thread_4925a28 |start | main | UIApplicationMain | -[UIApplication _run] | CFRunLoopRunInMode | CFRunLoopRunSpecific | __CFRunLoopRun | __CFRunLoopDoSource1 | __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__ | PurpleEventCallback | _PurpleEventCallback | _UIApplicationHandleEvent | -[UIApplication sendEvent:] | ...

ALLOC 0x9fd56f0-0xa64dacf [size=112]: thread_4925a28 |start | main | UIApplicationMain | GSEventRun | GSEventRunModal | CFRunLoopRunInMode | CFRunLoopRunSpecific | ... | rb_scope__initWithFillColor:__ | vm_dispatch | rb_vm_dispatch | builtin_ostub1(objc_object* (*)(objc_object*, objc_selector*, ...), objc_selector*, objc_object*, unsigned char, int, unsigned long*) | _objc_rootAlloc | class_createInstance | calloc | malloc_zone_calloc
</code></pre>

<p>The output shows there had been two mallocs in the life span of the app and only
one was freed.</p>

<p>If I was not expecting the first ALLOC to be freed, then I would investigate the
trace of the FREE to figure out why it was freed. Alternatively if I was expecting
the second ALLOC to be FREEd as well, then I would know that did not happen.</p>

<p>I knew I was expecting the memory to be freed and it was towards the end of the
second ALLOC block I could see my own method <code>initWithFillColor</code> being called.</p>

<p>I was subclassing <code>UIBarButtonItem</code> with my method <code>initWithFillColor</code> like so:</p>

<pre><code>  class MenuButton &lt; UIBarButtonItem

    def initWithFillColor(fillColor)
      UIBarButtonItem.alloc.initWithCustomView(button(fillColor))
    end

    private

    def showMenu
      # ...
    end

    def button(fillColor)
      UIMenuButtonIcon.alloc.initWithFrame(CGRectMake(0.0, 0.0, 25, 15), fillColor:fillColor).tap do |button|
        button.addTarget(self, action:"showMenu", forControlEvents:UIControlEventTouchUpInside)
      end
    end

  end
</code></pre>

<p>My <code>initWithFillColor</code> method obviously doesn&#8217;t need to create another instance
of <code>UIBarButtonItem</code>. So I updated it to the following and my memory bug was gone:</p>

<pre><code>def initWithFillColor(fillColor)
  initWithCustomView(button(fillColor))
end
</code></pre>

<p>Hopefully this is a good start for debugging any memory bugs in your RubyMotion
apps.</p>

<p>Thanks to the latest HipByte employee, <a href="http://blog.rubymotion.com/post/62652618638/eloy-duran-joins-the-rubymotion-team">Eloy Durán</a>, for the tips!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/09/how-to-debug-core-data-output-to-the-console-in-rubymotion/">How to Debug Core Data Output to the Console in RubyMotion</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-09T08:18:00+01:00" pubdate data-updated="true">Oct 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Core Data can show you the underlying queries and execution times whilst you
are running your app. Just fire it up with:</p>

<pre><code>rake args="-com.apple.CoreData.SQLDebug 1"
</code></pre>

<p>Note you can bump the number up to 2 or 3 depending on how much information
you want. 3 goes as far as to show you the result set Core Data has fetched.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/01/setting-the-status-bar-colour-for-ios7-in-rubymotion/">Setting the Status Bar Colour for iOS7 in RubyMotion</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-01T10:44:00+01:00" pubdate data-updated="true">Oct 1<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>First things first you need to set <code>UIViewControllerBasedStatusBarAppearance</code> in
your <code>info.plist</code>.</p>

<p>This is done by updating your <code>Rakefile</code> like so:</p>

<pre><code>app.info_plist['UIViewControllerBasedStatusBarAppearance'] = true
</code></pre>

<p>Now you need to implement the method <code>preferredStatusBarStyle</code> in your subclassed
<code>UINavigationController</code>:</p>

<pre><code>class MyCustomNavigationController &lt; UINavigationController

  def preferredStatusBarStyle
    UIStatusBarStyleLightContent
  end

end

class AppDelegate
  def application(application, didFinishLaunchingWithOptions:launchOptions)
    @window = UIWindow.alloc.initWithFrame(UIScreen.mainScreen.bounds)
    @window.makeKeyAndVisible
    controller = YourFirstController.alloc.init
    @window.rootViewController = MyCustomNavigationController.alloc.initWithRootController(controller)
    return true
  end
end
</code></pre>

<p>Note that <code>UIStatusBarStyleLightContent</code> will turn your status bar text color to white.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/01/how-to-use-the-crittercism-cocoapod-in-a-rubymotion-app/">How to Use the Crittercism Cocoapod in a RubyMotion App</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-01T10:24:00+01:00" pubdate data-updated="true">Jul 1<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.crittercism.com">Crittercism</a> is a great way of collecting data and
crash reports from your iOS application whilst it&#8217;s being used in realtime.</p>

<p>The easiest way to get it up and running in your RubyMotion app is to <a href="http://cocoapods.org/?q=crittercism">use the Coacoapod</a>.</p>

<p>If you haven&#8217;t setup Coacoapods in your app yet then check out my article
where I <a href="http://paulsturgess.co.uk/blog/2013/05/15/using-native-objective-c-cocoapod-libraries-in-rubymotion/">install the ViewDeck Cocoapod</a>.</p>

<p>Update your <code>Rakefile</code> with:</p>

<pre><code>Motion::Project::App.setup do |app|
  # ...

  app.frameworks += [
    'SystemConfiguration'
  ]

  app.pods do
    pod 'CrittercismSDK'
  end
end
</code></pre>

<p>Locate your Crittercism App id under Settings on the Crittercism website. Update
your <code>app_delegate.rb</code> with the following just before you call <code>makeKeyAndVisible</code>:</p>

<pre><code>crittercism_app_id = "51d1421f97c8f273e0000007"
Crittercism.enableWithAppID(crittercism_app_id)
</code></pre>

<p>Now when you build your app and errors get raised, you&#8217;ll start receiving crash
reports.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/28/how-to-memory-profile-a-rubymotion-application-using-instruments/">How to Memory Profile a RubyMotion Application Using Instruments</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-28T09:54:00+01:00" pubdate data-updated="true">Jun 28<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://developer.apple.com/library/mac/#documentation/developertools/conceptual/InstrumentsUserGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40004652-CH1-SW1">Instruments</a>, to quote Apple, &#8220;is a performance, analysis, and testing tool for dynamically tracing and profiling OS X and iOS code&#8221;.</p>

<p>Essentially it gives you live data while your application is running to
help track down memory leaks and performance issues.</p>

<h2>Profiling in the simulator</h2>

<p>Simply fire your application up and then open Xcode. Open Instruments via the menu:</p>

<pre><code>Xcode &gt; Open Developer Tool &gt; Instruments
</code></pre>

<p>Once Instruments had opened, I elected to keep the icon in the dock. This just
saves having to open Xcode each time I want to run Instruments.</p>

<p>Once you&#8217;ve chosen the type of profiling you want to perform, from the <code>Choose Target</code>
dropdown select, select <code>Attach to Process</code>. Under the <code>System</code> heading you should
see the name of your app to select.</p>

<p>Finally hit the record button and you&#8217;re good to go.</p>

<h2>Profiling whilst your app is running on your device</h2>

<p>First up make sure your device is recognised by Xcode to be &#8220;used for development&#8221;.</p>

<p>If you haven&#8217;t done this, connect your device to your computer and open Xcode
and open the organiser via:</p>

<pre><code>Xcode &gt; Window &gt; Organizer
</code></pre>

<p>Find your device and select &#8220;Use for development&#8221;</p>

<p>Now in Instruments you should be able to select your iPhone as a target. Then under
<code>Choose Target</code> you should get a list of your apps to choose from.</p>

<p>Note that your application must have been provisioned using a development profile.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/11/20/functional-programming-for-a-rubyist/">Functional Programming for a Rubyist</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/06/how-to-write-and-test-a-redux-container-component-for-react/">How to write and test a Redux Container Component for React</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/19/how-to-write-and-test-a-stateless-react-component/">How to write and test a stateless React component</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/14/safer-rebasing-with-git/">Safer rebasing with Git</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/09/29/elixir-london-conference-2016/">Elixir London Conference 2016</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/paulsturgess">@paulsturgess</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'paulsturgess',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Paul Sturgess -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
